generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Tenant {
  id                 String              @id @default(uuid())
  name               String
  status             String
  createdAt          DateTime            @default(now())
  domains            TenantDomain[]
  features           TenantFeature[]
  users              User[]
  patients           Patient[]
  encounters         Encounter[]
  labEncounterPreps  LabEncounterPrep[]
  radEncounterPreps  RadEncounterPrep[]
  opdEncounterPreps  OpdEncounterPrep[]
  bbEncounterPreps   BbEncounterPrep[]
  ipdEncounterPreps  IpdEncounterPrep[]
  patientSequences   PatientSequence[]
  encounterSequences EncounterSequence[]
  documents          Document[]
  auditEvents        AuditEvent[]
  invoices           Invoice[]
  payments           Payment[]
}

model TenantDomain {
  id        String   @id @default(uuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
  domain    String   @unique
  createdAt DateTime @default(now())

  @@index([tenantId])
}

model TenantFeature {
  id         String  @id @default(uuid())
  tenantId   String
  tenant     Tenant  @relation(fields: [tenantId], references: [id])
  key        String
  enabled    Boolean @default(false)
  configJson String?

  @@unique([tenantId, key])
  @@index([tenantId])
}

model User {
  id           String   @id @default(uuid())
  tenantId     String
  tenant       Tenant   @relation(fields: [tenantId], references: [id])
  email        String
  passwordHash String
  name         String?
  status       String   @default("active")
  createdAt    DateTime @default(now())

  roleMappings UserRole[]

  @@unique([tenantId, email])
  @@index([tenantId])
}

model Role {
  id          String           @id @default(uuid())
  tenantId    String
  name        String
  permissions RolePermission[]
  users       UserRole[]

  @@unique([tenantId, name])
}

model UserRole {
  userId String
  roleId String
  user   User   @relation(fields: [userId], references: [id])
  role   Role   @relation(fields: [roleId], references: [id])

  @@id([userId, roleId])
}

model Permission {
  id          String           @id @default(uuid())
  key         String           @unique
  description String?
  roles       RolePermission[]
}

model RolePermission {
  roleId       String
  permissionId String
  role         Role       @relation(fields: [roleId], references: [id])
  permission   Permission @relation(fields: [permissionId], references: [id])

  @@id([roleId, permissionId])
}

model AuditEvent {
  id            String   @id @default(uuid())
  tenantId      String
  tenant        Tenant   @relation(fields: [tenantId], references: [id])
  actorUserId   String?
  eventType     String
  entityType    String
  entityId      String
  payloadJson   String?
  createdAt     DateTime @default(now())
  correlationId String?

  @@index([tenantId, createdAt])
}

model Patient {
  id        String    @id @default(uuid())
  tenantId  String
  tenant    Tenant    @relation(fields: [tenantId], references: [id])
  regNo     String
  mrn       String?
  name      String
  dob       DateTime?
  gender    String?
  phone     String?
  createdAt DateTime  @default(now())

  encounters Encounter[]
  invoices   Invoice[]

  @@unique([tenantId, regNo])
  @@unique([tenantId, mrn])
  @@index([tenantId])
}

model Encounter {
  id            String   @id @default(uuid())
  tenantId      String
  tenant        Tenant   @relation(fields: [tenantId], references: [id])
  patientId     String
  patient       Patient  @relation(fields: [patientId], references: [id])
  encounterCode String
  type          String
  status        String   @default("CREATED")
  startedAt     DateTime @default(now())
  endedAt       DateTime?
  createdAt     DateTime @default(now())

  invoices Invoice[]
  documents Document[]
  labPrep   LabEncounterPrep?
  radPrep   RadEncounterPrep?
  opdPrep   OpdEncounterPrep?
  bbPrep    BbEncounterPrep?
  ipdPrep   IpdEncounterPrep?

  @@unique([tenantId, encounterCode])
  @@index([tenantId, patientId, createdAt])
}

model LabEncounterPrep {
  id            String    @id @default(uuid())
  tenantId      String
  tenant        Tenant    @relation(fields: [tenantId], references: [id])
  encounterId   String    @unique
  encounter     Encounter @relation(fields: [encounterId], references: [id])
  specimenType  String?
  collectedAt   DateTime?
  collectorName String?
  receivedAt    DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([tenantId])
  @@unique([tenantId, encounterId])
}

model RadEncounterPrep {
  id                  String    @id @default(uuid())
  tenantId            String
  tenant              Tenant    @relation(fields: [tenantId], references: [id])
  encounterId         String    @unique
  encounter           Encounter @relation(fields: [encounterId], references: [id])
  fastingRequired     Boolean?
  fastingConfirmed    Boolean?
  contrastPlanned     Boolean?
  creatinineChecked   Boolean?
  pregnancyScreenDone Boolean?
  notes               String?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  @@index([tenantId])
  @@unique([tenantId, encounterId])
}

model OpdEncounterPrep {
  id              String    @id @default(uuid())
  tenantId        String
  tenant          Tenant    @relation(fields: [tenantId], references: [id])
  encounterId     String    @unique
  encounter       Encounter @relation(fields: [encounterId], references: [id])
  systolicBp      Int?
  diastolicBp     Int?
  pulse           Int?
  temperatureC    Float?
  respiratoryRate Int?
  weightKg        Float?
  spo2            Int?
  triageNotes     String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([tenantId])
  @@unique([tenantId, encounterId])
}

model BbEncounterPrep {
  id                String    @id @default(uuid())
  tenantId          String
  tenant            Tenant    @relation(fields: [tenantId], references: [id])
  encounterId       String    @unique
  encounter         Encounter @relation(fields: [encounterId], references: [id])
  sampleReceivedAt  DateTime?
  aboGroup          String?
  rhType            String?
  componentRequested String?
  unitsRequested    Int?
  urgency           BbUrgency?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@index([tenantId])
  @@unique([tenantId, encounterId])
}

model IpdEncounterPrep {
  id             String    @id @default(uuid())
  tenantId       String
  tenant         Tenant    @relation(fields: [tenantId], references: [id])
  encounterId    String    @unique
  encounter      Encounter @relation(fields: [encounterId], references: [id])
  admissionReason String?
  ward           String?
  bed            String?
  admittingNotes String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@index([tenantId])
  @@unique([tenantId, encounterId])
}

model PatientSequence {
  tenantId  String   @id
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
  lastValue Int      @default(0)
  updatedAt DateTime @updatedAt
}

model EncounterSequence {
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
  type      String
  year      Int
  lastValue Int      @default(0)
  updatedAt DateTime @updatedAt

  @@id([tenantId, type, year])
}

model Invoice {
  id          String     @id @default(uuid())
  tenantId    String
  tenant      Tenant     @relation(fields: [tenantId], references: [id])
  patientId   String
  patient     Patient    @relation(fields: [patientId], references: [id])
  encounterId String?
  encounter   Encounter? @relation(fields: [encounterId], references: [id])
  status      String
  totalAmount Decimal
  currency    String
  createdAt   DateTime   @default(now())

  items    InvoiceItem[]
  payments Payment[]

  @@index([tenantId])
}

model InvoiceItem {
  id          String  @id @default(uuid())
  invoiceId   String
  invoice     Invoice @relation(fields: [invoiceId], references: [id])
  itemType    String
  itemRefId   String?
  description String
  qty         Int
  unitPrice   Decimal
  amount      Decimal
}

model Payment {
  id         String   @id @default(uuid())
  tenantId   String
  tenant     Tenant   @relation(fields: [tenantId], references: [id])
  invoiceId  String
  invoice    Invoice  @relation(fields: [invoiceId], references: [id])
  method     String
  amount     Decimal
  receivedAt DateTime @default(now())
  reference  String?

  @@index([tenantId])
}

model Document {
  id              String         @id @default(uuid())
  tenantId        String
  tenant          Tenant         @relation(fields: [tenantId], references: [id])
  encounterId     String
  encounter       Encounter      @relation(fields: [encounterId], references: [id])
  documentType    DocumentType
  status          DocumentStatus @default(QUEUED)
  payloadVersion  Int            @default(1)
  templateVersion Int            @default(1)
  payloadJson     Json
  payloadHash     String
  storageBackend  StorageBackend @default(LOCAL)
  storageKey      String?
  pdfHash         String?
  errorCode       String?
  errorMessage    String?
  createdAt       DateTime       @default(now())
  renderedAt      DateTime?

  @@index([tenantId])
  @@index([tenantId, encounterId])
  @@unique([tenantId, encounterId, documentType, templateVersion, payloadHash])
}

enum DocumentType {
  ENCOUNTER_SUMMARY
}

enum DocumentStatus {
  QUEUED
  RENDERED
  FAILED
}

enum StorageBackend {
  LOCAL
  S3
}

enum BbUrgency {
  ROUTINE
  URGENT
}
