generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Tenant {
  id                 String              @id @default(uuid())
  name               String
  status             String
  createdAt          DateTime            @default(now())
  domains            TenantDomain[]
  features           TenantFeature[]
  users              User[]
  patients           Patient[]
  encounters         Encounter[]
  labEncounterPreps  LabEncounterPrep[]
  radEncounterPreps  RadEncounterPrep[]
  opdEncounterPreps  OpdEncounterPrep[]
  bbEncounterPreps   BbEncounterPrep[]
  ipdEncounterPreps  IpdEncounterPrep[]
  labEncounterMains  LabEncounterMain[]
  radEncounterMains  RadEncounterMain[]
  opdEncounterMains  OpdEncounterMain[]
  bbEncounterMains   BbEncounterMain[]
  ipdEncounterMains  IpdEncounterMain[]
  patientSequences   PatientSequence[]
  encounterSequences EncounterSequence[]
  documents          Document[]
  auditEvents        AuditEvent[]
  invoices           Invoice[]
  payments           Payment[]
  labTestDefinitions LabTestDefinition[]
  labTestParameters  LabTestParameter[]
  labOrderItems      LabOrderItem[]
  labResultItems     LabResultItem[]
}

model TenantDomain {
  id        String   @id @default(uuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
  domain    String   @unique
  createdAt DateTime @default(now())

  @@index([tenantId])
}

model TenantFeature {
  id         String  @id @default(uuid())
  tenantId   String
  tenant     Tenant  @relation(fields: [tenantId], references: [id])
  key        String
  enabled    Boolean @default(false)
  configJson String?

  @@unique([tenantId, key])
  @@index([tenantId])
}

model User {
  id           String   @id @default(uuid())
  tenantId     String
  tenant       Tenant   @relation(fields: [tenantId], references: [id])
  email        String
  passwordHash String
  name         String?
  status       String   @default("active")
  createdAt    DateTime @default(now())

  roleMappings UserRole[]

  @@unique([tenantId, email])
  @@index([tenantId])
}

model Role {
  id          String           @id @default(uuid())
  tenantId    String
  name        String
  permissions RolePermission[]
  users       UserRole[]

  @@unique([tenantId, name])
}

model UserRole {
  userId String
  roleId String
  user   User   @relation(fields: [userId], references: [id])
  role   Role   @relation(fields: [roleId], references: [id])

  @@id([userId, roleId])
}

model Permission {
  id          String           @id @default(uuid())
  key         String           @unique
  description String?
  roles       RolePermission[]
}

model RolePermission {
  roleId       String
  permissionId String
  role         Role       @relation(fields: [roleId], references: [id])
  permission   Permission @relation(fields: [permissionId], references: [id])

  @@id([roleId, permissionId])
}

model AuditEvent {
  id            String   @id @default(uuid())
  tenantId      String
  tenant        Tenant   @relation(fields: [tenantId], references: [id])
  actorUserId   String?
  eventType     String
  entityType    String
  entityId      String
  payloadJson   String?
  createdAt     DateTime @default(now())
  correlationId String?

  @@index([tenantId, createdAt])
}

model Patient {
  id                   String    @id @default(uuid())
  tenantId             String
  tenant               Tenant    @relation(fields: [tenantId], references: [id])
  regNo                String
  mrn                  String?
  name                 String
  dob                  DateTime?
  gender               String?
  phone                String?
  fatherOrHusbandName  String?
  cnic                 String?
  address              String?
  createdAt            DateTime  @default(now())

  encounters Encounter[]
  invoices   Invoice[]

  @@unique([tenantId, regNo])
  @@unique([tenantId, mrn])
  @@index([tenantId])
}

model Encounter {
  id            String   @id @default(uuid())
  tenantId      String
  tenant        Tenant   @relation(fields: [tenantId], references: [id])
  patientId     String
  patient       Patient  @relation(fields: [patientId], references: [id])
  encounterCode String
  type          String
  status        String   @default("CREATED")
  startedAt     DateTime @default(now())
  endedAt       DateTime?
  createdAt     DateTime @default(now())

  invoices Invoice[]
  documents Document[]
  labPrep   LabEncounterPrep?
  radPrep   RadEncounterPrep?
  opdPrep   OpdEncounterPrep?
  bbPrep    BbEncounterPrep?
  ipdPrep   IpdEncounterPrep?
  labMain   LabEncounterMain?
  radMain   RadEncounterMain?
  opdMain   OpdEncounterMain?
  bbMain    BbEncounterMain?
  ipdMain   IpdEncounterMain?
  labOrderItems LabOrderItem[]

  @@unique([tenantId, encounterCode])
  @@index([tenantId, patientId, createdAt])
}

model LabEncounterPrep {
  id            String    @id @default(uuid())
  tenantId      String
  tenant        Tenant    @relation(fields: [tenantId], references: [id])
  encounterId   String    @unique
  encounter     Encounter @relation(fields: [encounterId], references: [id])
  specimenType  String?
  collectedAt   DateTime?
  collectorName String?
  receivedAt    DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([tenantId])
  @@unique([tenantId, encounterId])
}

model RadEncounterPrep {
  id                  String    @id @default(uuid())
  tenantId            String
  tenant              Tenant    @relation(fields: [tenantId], references: [id])
  encounterId         String    @unique
  encounter           Encounter @relation(fields: [encounterId], references: [id])
  fastingRequired     Boolean?
  fastingConfirmed    Boolean?
  contrastPlanned     Boolean?
  creatinineChecked   Boolean?
  pregnancyScreenDone Boolean?
  notes               String?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  @@index([tenantId])
  @@unique([tenantId, encounterId])
}

model OpdEncounterPrep {
  id              String    @id @default(uuid())
  tenantId        String
  tenant          Tenant    @relation(fields: [tenantId], references: [id])
  encounterId     String    @unique
  encounter       Encounter @relation(fields: [encounterId], references: [id])
  systolicBp      Int?
  diastolicBp     Int?
  pulse           Int?
  temperatureC    Float?
  respiratoryRate Int?
  weightKg        Float?
  spo2            Int?
  triageNotes     String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([tenantId])
  @@unique([tenantId, encounterId])
}

model BbEncounterPrep {
  id                String    @id @default(uuid())
  tenantId          String
  tenant            Tenant    @relation(fields: [tenantId], references: [id])
  encounterId       String    @unique
  encounter         Encounter @relation(fields: [encounterId], references: [id])
  sampleReceivedAt  DateTime?
  aboGroup          String?
  rhType            String?
  componentRequested String?
  unitsRequested    Int?
  urgency           BbUrgency?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@index([tenantId])
  @@unique([tenantId, encounterId])
}

model IpdEncounterPrep {
  id             String    @id @default(uuid())
  tenantId       String
  tenant         Tenant    @relation(fields: [tenantId], references: [id])
  encounterId    String    @unique
  encounter      Encounter @relation(fields: [encounterId], references: [id])
  admissionReason String?
  ward           String?
  bed            String?
  admittingNotes String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@index([tenantId])
  @@unique([tenantId, encounterId])
}

model LabEncounterMain {
  id            String    @id @default(uuid())
  tenantId      String
  tenant        Tenant    @relation(fields: [tenantId], references: [id])
  encounterId   String    @unique
  encounter     Encounter @relation(fields: [encounterId], references: [id])
  resultSummary String?
  verifiedBy    String?
  verifiedAt    DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([tenantId])
  @@unique([tenantId, encounterId])
}

model RadEncounterMain {
  id             String    @id @default(uuid())
  tenantId       String
  tenant         Tenant    @relation(fields: [tenantId], references: [id])
  encounterId    String    @unique
  encounter      Encounter @relation(fields: [encounterId], references: [id])
  reportText     String?
  impression     String?
  radiologistName String?
  reportedAt     DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@index([tenantId])
  @@unique([tenantId, encounterId])
}

model OpdEncounterMain {
  id               String    @id @default(uuid())
  tenantId         String
  tenant           Tenant    @relation(fields: [tenantId], references: [id])
  encounterId      String    @unique
  encounter        Encounter @relation(fields: [encounterId], references: [id])
  chiefComplaint   String?
  assessment       String?
  plan             String?
  prescriptionText String?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  @@index([tenantId])
  @@unique([tenantId, encounterId])
}

model BbEncounterMain {
  id               String             @id @default(uuid())
  tenantId         String
  tenant           Tenant             @relation(fields: [tenantId], references: [id])
  encounterId      String             @unique
  encounter        Encounter          @relation(fields: [encounterId], references: [id])
  crossmatchResult BbCrossmatchResult?
  componentIssued  String?
  unitsIssued      Int?
  issuedAt         DateTime?
  issueNotes       String?
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt

  @@index([tenantId])
  @@unique([tenantId, encounterId])
}

model IpdEncounterMain {
  id          String    @id @default(uuid())
  tenantId    String
  tenant      Tenant    @relation(fields: [tenantId], references: [id])
  encounterId String    @unique
  encounter   Encounter @relation(fields: [encounterId], references: [id])
  dailyNote   String?
  orders      String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([tenantId])
  @@unique([tenantId, encounterId])
}

model LabTestDefinition {
  id         String   @id @default(uuid())
  tenantId   String
  tenant     Tenant   @relation(fields: [tenantId], references: [id])
  code       String
  name       String
  department String
  active     Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  parameters LabTestParameter[]
  orderItems LabOrderItem[]

  @@unique([tenantId, code])
  @@index([tenantId, active, name])
}

model LabTestParameter {
  id           String            @id @default(uuid())
  tenantId     String
  tenant       Tenant            @relation(fields: [tenantId], references: [id])
  testId       String
  test         LabTestDefinition @relation(fields: [testId], references: [id])
  name         String
  unit         String?
  refLow       Float?
  refHigh      Float?
  refText      String?
  displayOrder Int               @default(0)
  active       Boolean           @default(true)
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt

  resultItems LabResultItem[]

  @@index([tenantId, testId, displayOrder])
  @@unique([tenantId, testId, name])
}

model LabOrderItem {
  id          String             @id @default(uuid())
  tenantId    String
  tenant      Tenant             @relation(fields: [tenantId], references: [id])
  encounterId String
  encounter   Encounter          @relation(fields: [encounterId], references: [id])
  testId      String
  test        LabTestDefinition  @relation(fields: [testId], references: [id])
  status      LabOrderItemStatus @default(ORDERED)
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt

  results LabResultItem[]

  @@unique([tenantId, encounterId, testId])
  @@index([tenantId, encounterId, status])
}

model LabResultItem {
  id          String        @id @default(uuid())
  tenantId    String
  tenant      Tenant        @relation(fields: [tenantId], references: [id])
  orderItemId String
  orderItem   LabOrderItem  @relation(fields: [orderItemId], references: [id])
  parameterId String
  parameter   LabTestParameter @relation(fields: [parameterId], references: [id])
  value       String
  valueNumeric Float?
  flag        LabResultFlag @default(UNKNOWN)
  enteredBy   String?
  enteredAt   DateTime?
  verifiedBy  String?
  verifiedAt  DateTime?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  @@unique([tenantId, orderItemId, parameterId])
  @@index([tenantId, orderItemId])
}

model PatientSequence {
  tenantId  String   @id
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
  lastValue Int      @default(0)
  updatedAt DateTime @updatedAt
}

model EncounterSequence {
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
  type      String
  year      Int
  lastValue Int      @default(0)
  updatedAt DateTime @updatedAt

  @@id([tenantId, type, year])
}

model Invoice {
  id          String     @id @default(uuid())
  tenantId    String
  tenant      Tenant     @relation(fields: [tenantId], references: [id])
  patientId   String
  patient     Patient    @relation(fields: [patientId], references: [id])
  encounterId String?
  encounter   Encounter? @relation(fields: [encounterId], references: [id])
  status      String
  totalAmount Decimal
  currency    String
  createdAt   DateTime   @default(now())

  items    InvoiceItem[]
  payments Payment[]

  @@index([tenantId])
}

model InvoiceItem {
  id          String  @id @default(uuid())
  invoiceId   String
  invoice     Invoice @relation(fields: [invoiceId], references: [id])
  itemType    String
  itemRefId   String?
  description String
  qty         Int
  unitPrice   Decimal
  amount      Decimal
}

model Payment {
  id         String   @id @default(uuid())
  tenantId   String
  tenant     Tenant   @relation(fields: [tenantId], references: [id])
  invoiceId  String
  invoice    Invoice  @relation(fields: [invoiceId], references: [id])
  method     String
  amount     Decimal
  receivedAt DateTime @default(now())
  reference  String?

  @@index([tenantId])
}

model Document {
  id              String         @id @default(uuid())
  tenantId        String
  tenant          Tenant         @relation(fields: [tenantId], references: [id])
  encounterId     String
  encounter       Encounter      @relation(fields: [encounterId], references: [id])
  documentType    DocumentType
  status          DocumentStatus @default(QUEUED)
  payloadVersion  Int            @default(1)
  templateVersion Int            @default(1)
  payloadJson     Json
  payloadHash     String
  storageBackend  StorageBackend @default(LOCAL)
  storageKey      String?
  pdfHash         String?
  errorCode       String?
  errorMessage    String?
  createdAt       DateTime       @default(now())
  renderedAt      DateTime?

  @@index([tenantId])
  @@index([tenantId, encounterId])
  @@unique([tenantId, encounterId, documentType, templateVersion, payloadHash])
}

enum DocumentType {
  ENCOUNTER_SUMMARY
}

enum DocumentStatus {
  QUEUED
  RENDERED
  FAILED
}

enum StorageBackend {
  LOCAL
  S3
}

enum BbUrgency {
  ROUTINE
  URGENT
}

enum BbCrossmatchResult {
  COMPATIBLE
  INCOMPATIBLE
}

enum LabOrderItemStatus {
  ORDERED
  RESULTS_ENTERED
  VERIFIED
}

enum LabResultFlag {
  LOW
  HIGH
  NORMAL
  ABNORMAL
  UNKNOWN
}
