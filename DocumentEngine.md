# DocumentEngine.md
Date: 2026-02-18

## Goal
A single, platform-wide document engine capable of generating:
- Lab reports (A4/A5)
- Receipts/invoices (A4/A5)
- History/requisition forms (A4)
- Future: manifests, QC logs, certificates

Official published PDFs are generated by **PDF Service (QuestPDF)**.

## Core concepts
### DocumentType
A stable identifier:
- `lims.report.single.v1`
- `lims.report.panel_table.v1`
- `lims.report.hematology_grouped.v1`
- `billing.receipt.a5.v1`
- `forms.history.a4.v1`

### PayloadVersion
Document payload schemas are versioned:
- `payload_version = "v1"`
- When changing structure, create `v2`, never break `v1`.

### TemplateVersion
Template evolves independently:
- `template_version = "1.0.0"`
- Store template version with every published document.

### Hashing and reproducibility
Store:
- `payload_hash = sha256(canonical_json(payload))`
- `pdf_hash = sha256(pdf_bytes)`
- Reprints must return the same stored PDF bytes (preferred) or regenerate using same payload+template versions.

## Rendering pipeline
1. API builds payload and selects documentType + templateVersion
2. API calls PDF service `/render`
3. PDF service returns bytes and (optionally) pdf_hash header
4. API stores bytes and records document metadata

## Tenant branding
Branding is provided as input to renderer:
- logo image (base64 or URL internal)
- header lines
- footer disclaimer
- signatories
- optional watermark

Branding is versioned as part of tenant config.

## Template families
Templates are not per-test. Templates are per layout family:
- Single parameter
- Panel table
- Hematology grouped
- Receipt
- Form

Test-specific overrides are allowed only as exceptions via:
- `test.template_override` (rare, audited)

## PDF service requirements
- Stateless
- Deterministic
- Pinned fonts bundled with service
- Handles page breaks predictably
